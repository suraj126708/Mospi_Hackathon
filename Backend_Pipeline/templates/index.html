<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Injection Pipeline</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
      }

      .upload-area:hover {
        border-color: #007bff;
        background-color: #e3f2fd;
      }

      .upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
      }

      .upload-area.required {
        border-color: #dc3545;
        background-color: #f8d7da;
      }

      .file-input {
        display: none;
      }

      .progress-container {
        display: none;
        margin-top: 30px;
      }

      .log-container {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 14px;
      }

      .step-indicator {
        display: flex;
        justify-content: space-between;
        margin: 30px 0;
      }

      .step {
        flex: 1;
        text-align: center;
        padding: 15px;
        margin: 0 5px;
        border-radius: 8px;
        background-color: #e9ecef;
        position: relative;
      }

      .step.active {
        background-color: #007bff;
        color: white;
      }

      .step.completed {
        background-color: #28a745;
        color: white;
      }

      .step.error {
        background-color: #dc3545;
        color: white;
      }

      .step:not(:last-child)::after {
        content: "";
        position: absolute;
        top: 50%;
        right: -10px;
        width: 20px;
        height: 2px;
        background-color: #dee2e6;
        transform: translateY(-50%);
      }

      .step.completed:not(:last-child)::after {
        background-color: #28a745;
      }

      .api-section {
        display: none;
        margin-top: 30px;
      }

      .file-preview {
        margin-top: 15px;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        display: none;
      }

      .btn-custom {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        color: white;
      }

      .btn-success-custom {
        background: linear-gradient(45deg, #28a745, #1e7e34);
      }

      .btn-success-custom:hover {
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
              <i class="fas fa-database me-3"></i>
              Data Injection Pipeline
            </h1>
            <p class="lead text-muted">
              Upload your PDF and CSV files to start the automated data
              processing pipeline
            </p>
          </div>

          <!-- File Upload Section -->
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-upload me-2"></i>
                Step 1: Upload Files
              </h5>
            </div>
            <div class="card-body">
              <form id="uploadForm" enctype="multipart/form-data">
                <div class="row">
                  <div class="col-md-6">
                    <div class="upload-area" id="pdfUploadArea">
                      <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                      <h6>Upload PDF File</h6>
                      <p class="text-muted">Drag & drop or click to select</p>
                      <input
                        type="file"
                        id="pdfFile"
                        name="pdf_file"
                        class="file-input"
                        accept=".pdf"
                      />
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        onclick="document.getElementById('pdfFile').click()"
                      >
                        Choose PDF File
                      </button>
                    </div>
                    <div class="file-preview" id="pdfPreview"></div>
                  </div>
                  <div class="col-md-6">
                    <div class="upload-area" id="csvUploadArea">
                      <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                      <h6>Upload CSV File</h6>
                      <p class="text-muted">Drag & drop or click to select</p>
                      <input
                        type="file"
                        id="csvFile"
                        name="csv_file"
                        class="file-input"
                        accept=".csv"
                      />
                      <button
                        type="button"
                        class="btn btn-outline-success"
                        onclick="document.getElementById('csvFile').click()"
                      >
                        Choose CSV File
                      </button>
                    </div>
                    <div class="file-preview" id="csvPreview"></div>
                  </div>
                </div>
                <div class="text-center mt-4">
                  <button type="submit" class="btn btn-custom btn-lg">
                    <i class="fas fa-upload me-2"></i>
                    Upload Files
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Pipeline Steps Indicator -->
          <div class="step-indicator" id="stepIndicator" style="display: none">
            <div class="step" id="step1">
              <i class="fas fa-file-upload"></i>
              <div class="mt-2">Files Uploaded</div>
            </div>
            <div class="step" id="step2">
              <i class="fas fa-file-pdf"></i>
              <div class="mt-2">PDF to Metadata</div>
            </div>
            <div class="step" id="step3">
              <i class="fas fa-database"></i>
              <div class="mt-2">Metadata Ingestion</div>
            </div>
            <div class="step" id="step4">
              <i class="fas fa-table"></i>
              <div class="mt-2">Microdata Ingestion</div>
            </div>
            <div class="step" id="step5">
              <i class="fas fa-check-circle"></i>
              <div class="mt-2">Complete</div>
            </div>
          </div>

          <!-- Pipeline Control Section -->
          <div
            class="card shadow-sm mt-4"
            id="pipelineControl"
            style="display: none"
          >
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-play me-2"></i>
                Step 2: Start Pipeline
              </h5>
            </div>
            <div class="card-body text-center">
              <button
                id="startPipelineBtn"
                class="btn btn-success-custom btn-lg"
              >
                <i class="fas fa-rocket me-2"></i>
                Start Data Processing Pipeline
              </button>
            </div>
          </div>

          <!-- Progress Section -->
          <div class="progress-container" id="progressContainer">
            <div class="card shadow-sm">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                  <i class="fas fa-tasks me-2"></i>
                  Pipeline Progress
                </h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <strong>Current Step:</strong> <span id="currentStep">-</span>
                </div>
                <div class="progress mb-3" style="height: 25px">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    id="progressBar"
                    role="progressbar"
                    style="width: 0%"
                  >
                    0%
                  </div>
                </div>
                <div class="log-container" id="logContainer">
                  <div class="text-muted">
                    Pipeline logs will appear here...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- API Call Section -->
          <div class="api-section" id="apiSection">
            <div class="card shadow-sm">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                  <i class="fas fa-link me-2"></i>
                  Step 3: API Integration
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted mb-3">
                  Enter the API URL to call your existing API service:
                </p>
                <div class="input-group mb-3">
                  <span class="input-group-text">
                    <i class="fas fa-globe"></i>
                  </span>
                  <input
                    type="url"
                    class="form-control"
                    id="apiUrl"
                    placeholder="https://your-api-endpoint.com/endpoint"
                    required
                  />
                  <button class="btn btn-warning" type="button" id="callApiBtn">
                    <i class="fas fa-paper-plane me-2"></i>
                    Call API
                  </button>
                </div>
                <div id="apiResult" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
      let uploadedFiles = {};
      let pipelineRunning = false;
      let statusCheckInterval;

      // File upload handling
      document
        .getElementById("pdfFile")
        .addEventListener("change", function (e) {
          handleFileSelect(e.target.files[0], "pdf", "pdfPreview");
        });

      document
        .getElementById("csvFile")
        .addEventListener("change", function (e) {
          handleFileSelect(e.target.files[0], "csv", "csvPreview");
        });

      function handleFileSelect(file, type, previewId) {
        if (file) {
          uploadedFiles[type] = file;
          const preview = document.getElementById(previewId);
          preview.innerHTML = `
                    <strong>Selected:</strong> ${file.name}<br>
                    <small class="text-muted">Size: ${(
                      file.size /
                      1024 /
                      1024
                    ).toFixed(2)} MB</small>
                `;
          preview.style.display = "block";
        }
      }

      // Drag and drop functionality
      ["pdfUploadArea", "csvUploadArea"].forEach((id) => {
        const area = document.getElementById(id);

        area.addEventListener("dragover", (e) => {
          e.preventDefault();
          area.classList.add("dragover");
        });

        area.addEventListener("dragleave", () => {
          area.classList.remove("dragover");
        });

        area.addEventListener("drop", (e) => {
          e.preventDefault();
          area.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            const type = id === "pdfUploadArea" ? "pdf" : "csv";
            const input = document.getElementById(type + "File");
            input.files = files;
            handleFileSelect(file, type, type + "Preview");
          }
        });
      });

      // Form submission
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Manual validation
          if (!uploadedFiles.pdf) {
            alert("Please select a PDF file");
            document.getElementById("pdfFile").focus();
            return;
          }

          if (!uploadedFiles.csv) {
            alert("Please select a CSV file");
            document.getElementById("csvFile").focus();
            return;
          }

          const formData = new FormData();
          formData.append("pdf_file", uploadedFiles.pdf);
          formData.append("csv_file", uploadedFiles.csv);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              showSuccess("Files uploaded successfully!");
              document.getElementById("stepIndicator").style.display = "flex";
              document.getElementById("pipelineControl").style.display =
                "block";
              updateStep(1, "completed");
            } else {
              showError(result.error);
            }
          } catch (error) {
            showError("Upload failed: " + error.message);
          }
        });

      // Start pipeline
      document
        .getElementById("startPipelineBtn")
        .addEventListener("click", async function () {
          if (pipelineRunning) return;

          try {
            const response = await fetch("/start_pipeline", {
              method: "POST",
            });

            const result = await response.json();

            if (result.success) {
              pipelineRunning = true;
              document.getElementById("progressContainer").style.display =
                "block";
              document.getElementById("startPipelineBtn").disabled = true;
              document.getElementById("startPipelineBtn").innerHTML =
                '<i class="fas fa-spinner fa-spin me-2"></i>Pipeline Running...';

              // Start status checking
              startStatusCheck();
            } else {
              showError(result.error);
            }
          } catch (error) {
            showError("Failed to start pipeline: " + error.message);
          }
        });

      // API call
      document
        .getElementById("callApiBtn")
        .addEventListener("click", async function () {
          const apiUrl = document.getElementById("apiUrl").value.trim();

          if (!apiUrl) {
            showError("Please enter a valid API URL");
            return;
          }

          try {
            const response = await fetch("/api_call", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ api_url: apiUrl }),
            });

            const result = await response.json();

            if (result.success) {
              showApiSuccess(result.message);
            } else {
              showApiError(result.error);
            }
          } catch (error) {
            showApiError("API call failed: " + error.message);
          }
        });

      // Status checking
      function startStatusCheck() {
        statusCheckInterval = setInterval(checkPipelineStatus, 1000);
      }

      async function checkPipelineStatus() {
        try {
          const response = await fetch("/pipeline_status");
          const status = await response.json();

          updateProgress(status);

          if (status.completed || status.error) {
            clearInterval(statusCheckInterval);
            pipelineRunning = false;
            document.getElementById("startPipelineBtn").disabled = false;
            document.getElementById("startPipelineBtn").innerHTML =
              '<i class="fas fa-play me-2"></i>Start Data Processing Pipeline';

            if (status.completed) {
              updateStep(5, "completed");
              document.getElementById("apiSection").style.display = "block";
              showSuccess(
                "Pipeline completed successfully! You can now proceed with the API call."
              );
            } else if (status.error) {
              showError("Pipeline failed: " + status.error);
            }
          }
        } catch (error) {
          console.error("Status check failed:", error);
        }
      }

      function updateProgress(status) {
        document.getElementById("currentStep").textContent =
          status.current_step || "-";
        document.getElementById("progressBar").style.width =
          status.progress + "%";
        document.getElementById("progressBar").textContent =
          status.progress + "%";

        if (status.logs && status.logs.length > 0) {
          const logContainer = document.getElementById("logContainer");
          logContainer.innerHTML = status.logs
            .map((log) => `<div>${log}</div>`)
            .join("");
          logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Update step indicators based on progress
        if (status.progress >= 20) updateStep(2, "active");
        if (status.progress >= 50) updateStep(2, "completed");
        if (status.progress >= 70) updateStep(3, "completed");
        if (status.progress >= 85) updateStep(4, "completed");
      }

      function updateStep(stepNumber, status) {
        const step = document.getElementById(`step${stepNumber}`);
        step.className = `step ${status}`;
      }

      // Utility functions
      function showSuccess(message) {
        // You can implement a toast notification here
        console.log("Success:", message);
      }

      function showError(message) {
        // You can implement a toast notification here
        console.error("Error:", message);
      }

      function showApiSuccess(message) {
        const resultDiv = document.getElementById("apiResult");
        resultDiv.innerHTML = `<div class="alert alert-success">${message}</div>`;
      }

      function showApiError(message) {
        const resultDiv = document.getElementById("apiResult");
        resultDiv.innerHTML = `<div class="alert alert-danger">${message}</div>`;
      }
    </script>
  </body>
</html>
